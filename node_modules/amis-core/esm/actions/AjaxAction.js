/**
 * amis-core v3.6.3
 * Copyright 2018-2023 fex
 */

import { __awaiter, __generator, __assign } from 'tslib';
import { normalizeApiResponseData, normalizeApi } from '../utils/api.js';
import { ServerError } from '../utils/errors.js';
import { isEmpty } from '../utils/helper.js';
import { registerAction } from './Action.js';
import { createObject } from '../utils/object.js';

/**
 * 发送请求动作
 *
 * @export
 * @class AjaxAction
 * @implements {Action}
 */
var AjaxAction = /** @class */ (function () {
    function AjaxAction(fetcherType) {
        if (fetcherType === void 0) { fetcherType = 'ajax'; }
        this.fetcherType = fetcherType;
    }
    AjaxAction.prototype.run = function (action, renderer, event) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m;
        return __awaiter(this, void 0, void 0, function () {
            var env, silent, messages, api, result, responseData, msg, e_1, result;
            var _o;
            return __generator(this, function (_p) {
                switch (_p.label) {
                    case 0:
                        if (!((_a = event.context.env) === null || _a === void 0 ? void 0 : _a.fetcher)) {
                            throw new Error('env.fetcher is required!');
                        }
                        if (!action.api) {
                            throw new Error('api is required!');
                        }
                        if (this.fetcherType === 'download' && action.actionType === 'download') {
                            if (action.api) {
                                action.api.responseType = 'blob';
                            }
                        }
                        env = event.context.env;
                        silent = ((_b = action === null || action === void 0 ? void 0 : action.options) === null || _b === void 0 ? void 0 : _b.silent) || (action === null || action === void 0 ? void 0 : action.api).silent;
                        messages = (_c = action === null || action === void 0 ? void 0 : action.api) === null || _c === void 0 ? void 0 : _c.messages;
                        api = normalizeApi(action.api);
                        // 如果没配置data数据映射，则给一个空对象，避免将当前数据域作为接口请求参数
                        if ((api === null || api === void 0 ? void 0 : api.data) == undefined) {
                            api = __assign(__assign({}, api), { data: {} });
                        }
                        _p.label = 1;
                    case 1:
                        _p.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, env.fetcher(api, (_d = action.data) !== null && _d !== void 0 ? _d : {}, (_e = action === null || action === void 0 ? void 0 : action.options) !== null && _e !== void 0 ? _e : {})];
                    case 2:
                        result = _p.sent();
                        responseData = !isEmpty(result.data) || result.ok
                            ? normalizeApiResponseData(result.data)
                            : null;
                        // 记录请求返回的数据
                        event.setData(createObject(event.data, __assign(__assign({}, responseData), (_o = { responseData: responseData }, _o[action.outputVar || 'responseResult'] = __assign(__assign({}, responseData), { responseData: responseData, responseStatus: result.status, responseMsg: result.msg }), _o))));
                        if (!silent) {
                            if (!result.ok) {
                                throw new ServerError((_h = (_f = messages === null || messages === void 0 ? void 0 : messages.failed) !== null && _f !== void 0 ? _f : (_g = action.messages) === null || _g === void 0 ? void 0 : _g.failed) !== null && _h !== void 0 ? _h : result.msg, result);
                            }
                            else {
                                msg = (_m = (_l = (_j = messages === null || messages === void 0 ? void 0 : messages.success) !== null && _j !== void 0 ? _j : (_k = action.messages) === null || _k === void 0 ? void 0 : _k.success) !== null && _l !== void 0 ? _l : result.msg) !== null && _m !== void 0 ? _m : result.defaultMsg;
                                msg &&
                                    env.notify('success', msg, result.msgTimeout !== undefined
                                        ? {
                                            closeButton: true,
                                            timeout: result.msgTimeout
                                        }
                                        : undefined);
                            }
                        }
                        return [2 /*return*/, result.data];
                    case 3:
                        e_1 = _p.sent();
                        if (!silent) {
                            if (e_1.type === 'ServerError') {
                                result = e_1.response;
                                env.notify('error', e_1.message, result.msgTimeout !== undefined
                                    ? {
                                        closeButton: true,
                                        timeout: result.msgTimeout
                                    }
                                    : undefined);
                            }
                            else {
                                env.notify('error', e_1.message);
                            }
                        }
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    return AjaxAction;
}());
registerAction('ajax', new AjaxAction());
registerAction('download', new AjaxAction('download'));

export { AjaxAction };
